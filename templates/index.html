<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDS Live Monitor - Advanced</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { background-color: #0d1117; color: #c9d1d9; font-family: 'Courier New', Courier, monospace; }
        .card { background-color: #161b22; border: 1px solid #30363d; margin-bottom: 20px; }
        .table { color: #c9d1d9; }
        .table-hover tbody tr:hover { background-color: #21262d; }
        .text-neon { color: #58a6ff; text-shadow: 0 0 5px #58a6ff; }
        .text-danger-neon { color: #ff7b72; text-shadow: 0 0 5px #ff7b72; }
        #map { height: 300px; width: 100%; border-radius: 4px; }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0d1117; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
        
        .severity-critical { color: #ff7b72; font-weight: bold; }
        .severity-high { color: #ffa657; }
        .severity-medium { color: #d2a8ff; }
        .severity-low { color: #79c0ff; }
    </style>
</head>
<body class="p-3">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-neon m-0"> <span class="badge bg-danger">LIVE</span> IDS DASHBOARD v2.0</h2>
            <div class="text-end text-muted small">
                Status: <span id="system-status" class="text-success">Connected</span>
            </div>
        </div>
        
        <div class="row">
            <!-- Stats Columns -->
            <div class="col-lg-3">
                <div class="row">
                    <div class="col-6 col-lg-12">
                        <div class="card p-3 text-center">
                            <h6 class="text-muted">Total Alerts</h6>
                            <h2 id="total-alerts" class="text-white">0</h2>
                        </div>
                    </div>
                    <div class="col-6 col-lg-12">
                        <div class="card p-3 text-center">
                            <h6 class="text-muted">Critical Threats</h6>
                            <h2 id="high-risk-count" class="text-danger-neon">0</h2>
                        </div>
                    </div>
                </div>
                <div class="card p-3">
                     <h6 class="text-muted mb-3">Threat Distribution</h6>
                     <div style="height: 150px;">
                        <canvas id="threatChart"></canvas>
                     </div>
                </div>
            </div>
            
            <!-- Map Column -->
            <div class="col-lg-9">
                <div class="card p-2">
                    <div id="map"></div>
                </div>
            </div>
        </div>

        <!-- Filter Controls -->
        <div class="row mb-3">
            <div class="col-md-12">
                <div class="card p-3 d-flex flex-row gap-3 align-items-center">
                    <span class="text-muted">FILTERS:</span>
                    <input type="text" id="filter-ip" class="form-control form-control-sm bg-dark text-white border-secondary" placeholder="Search IP..." style="width: 200px;">
                    <select id="filter-type" class="form-select form-select-sm bg-dark text-white border-secondary" style="width: 150px;">
                        <option value="all">All Types</option>
                        <option value="port_scan">Port Scan</option>
                        <option value="syn_flood">SYN Flood</option>
                        <option value="ddos">DDoS</option>
                    </select>
                    <button class="btn btn-sm btn-outline-primary" onclick="applyFilters()">Apply</button>
                    <button class="btn btn-sm btn-outline-success ms-auto" onclick="exportData()">Export CSV</button>
                </div>
            </div>
        </div>

        <!-- Alerts Table -->
        <div class="card p-3">
            <h4 class="mb-3 text-white">Live Threat Feed</h4>
            <div style="overflow-y: auto; max-height: 400px;">
                <table class="table table-hover table-dark table-sm">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Severity</th>
                            <th>Type</th>
                            <th>Source</th>
                            <th>Target</th>
                            <th>Location</th>
                            <th>Conf.</th>
                        </tr>
                    </thead>
                    <tbody id="alert-table-body">
                        <!-- Rows injected via JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let allAlerts = [];
        
        // Map Init
        const map = L.map('map').setView([20, 0], 2);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        const markers = {};

        // Chart Init
        const ctx = document.getElementById('threatChart').getContext('2d');
        const threatChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Port Scan', 'SYN Flood', 'DDoS', 'Other'],
                datasets: [{
                    data: [0, 0, 0, 0],
                    backgroundColor: ['#d2a8ff', '#79c0ff', '#ff7b72', '#bcc4cc'],
                    borderWidth: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });

        // Load Initial History
        fetch('/api/history?limit=100')
            .then(r => r.json())
            .then(data => {
                data.forEach(alert => {
                   processAlert(alert, false); // Don't animate map for history
                });
                allAlerts = data;
                updateStats();
                renderTable();
            });

        // Real-time Updates
        socket.on('new_alert', function(alert) {
            allAlerts.unshift(alert);
            if(allAlerts.length > 500) allAlerts.pop();
            
            processAlert(alert, true);
            updateStats();
            renderTable();
        });

        function processAlert(alert, animate) {
             // Geolocate if source IP is new
             const ip = alert.source_ip;
             if (ip && !markers[ip]) {
                 fetch(`/api/geolocate/${ip}`)
                    .then(r => r.json())
                    .then(loc => {
                        if (loc.lat) {
                            const marker = L.circleMarker([loc.lat, loc.lon], {
                                radius: 5,
                                color: '#ff7b72',
                                fillColor: '#ff7b72',
                                fillOpacity: 0.7
                            }).addTo(map);
                            marker.bindPopup(`<b>${ip}</b><br>${loc.city}, ${loc.country}`);
                            markers[ip] = marker;
                            
                            if (animate) {
                                marker.setRadius(15);
                                setTimeout(() => marker.setRadius(5), 500);
                            }
                        }
                    });
             }
        }

        function updateStats() {
            document.getElementById('total-alerts').innerText = allAlerts.length;
            const critical = allAlerts.filter(a => a.confidence > 0.8).length;
            document.getElementById('high-risk-count').innerText = critical;
            
            // Update chart data
            const counts = {
                'port_scan': 0, 'syn_flood': 0, 'ddos': 0, 'other': 0
            };
            
            allAlerts.forEach(a => {
                if (a.rule === 'port_scan' || a.threat_type === 'port_scan') counts.port_scan++;
                else if (a.rule === 'syn_flood') counts.syn_flood++;
                else if (a.rule === 'ddos') counts.ddos++;
                else counts.other++;
            });
            
            threatChart.data.datasets[0].data = [counts.port_scan, counts.syn_flood, counts.ddos, counts.other];
            threatChart.update();
        }

        function renderTable() {
            const tbody = document.getElementById('alert-table-body');
            tbody.innerHTML = '';
            
            const filterIP = document.getElementById('filter-ip').value.toLowerCase();
            const filterType = document.getElementById('filter-type').value;

            const filtered = allAlerts.filter(a => {
                if (filterIP && !a.source_ip.includes(filterIP)) return false;
                if (filterType !== 'all' && (a.rule !== filterType && a.threat_type !== filterType)) return false;
                return true;
            });

            filtered.slice(0, 50).forEach(alert => {
                const row = document.createElement('tr');
                
                let severityClass = 'severity-low';
                if(alert.confidence > 0.8) severityClass = 'severity-critical';
                else if(alert.confidence > 0.6) severityClass = 'severity-high';
                else if(alert.confidence > 0.4) severityClass = 'severity-medium';
                
                row.innerHTML = `
                    <td>${formatDate(alert.timestamp)}</td>
                    <td class="${severityClass}">${(alert.severity || 'LOW').toUpperCase()}</td>
                    <td><span class="badge bg-secondary">${alert.rule || alert.threat_type}</span></td>
                    <td class="text-monospace">${alert.source_ip}</td>
                    <td class="text-monospace">${alert.destination_ip}</td>
                    <td id="loc-${alert.source_ip.replace(/\./g, '-')}">Processing...</td>
                    <td>${Math.round(alert.confidence * 100)}%</td>
                `;
                tbody.appendChild(row);
                
                // Update location cell if we have it
                fetch(`/api/geolocate/${alert.source_ip}`)
                    .then(r => r.json())
                    .then(loc => {
                         const cell = document.getElementById(`loc-${alert.source_ip.replace(/\./g, '-')}`);
                         if(cell && loc.country) cell.innerText = `${loc.country}`;
                         else if(cell) cell.innerText = 'Unknown';
                    });
            });
        }
        
        function formatDate(isoString) {
            const d = new Date(isoString);
            return d.toLocaleTimeString();
        }

        function applyFilters() {
            renderTable();
        }

        function exportData() {
            let csv = 'Timestamp,Type,Source,Target,Confidence\n';
            allAlerts.forEach(a => {
                csv += `${a.timestamp},${a.threat_type},${a.source_ip},${a.destination_ip},${a.confidence}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'ids_alerts.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>